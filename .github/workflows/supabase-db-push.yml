name: Supabase DB Push

on:
  push:
    paths:
      - "supabase/migrations/**"
      - ".github/workflows/supabase-db-push.yml"
  workflow_dispatch:

jobs:
  push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1

      - name: Supabase CLI version
        run: supabase --version

      # Build de URL IPv4 "best-effort" (não falha o job se não conseguir)
      - name: Build IPv4 DSN (best-effort)
        id: v4dsn
        shell: bash
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          DBURL="$SUPABASE_DB_URL"
          # Extrai o host da URI usando Python (sem libs extras)
          HOST="$(python3 - "$DBURL" <<'PY'
import sys, urllib.parse
u = urllib.parse.urlsplit(sys.argv[1].replace('postgresql://','http://',1))
print(u.hostname or '')
PY
)"
          if [ -z "$HOST" ]; then
            echo "Host não identificado; seguindo com a URL original."
            exit 0
          fi

          # Resolve apenas IPv4 (gethostbyname retorna A record)
          IPV4="$(python3 - "$HOST" <<'PY'
import socket, sys
try:
    print(socket.gethostbyname(sys.argv[1]))
except Exception:
    print("")
PY
)"
          if [ -n "$IPV4" ]; then
            DBURL_V4="${DBURL/$HOST/$IPV4}"
            echo "SUPABASE_DB_URL_V4=$DBURL_V4" >> "$GITHUB_ENV"
            echo "IPv4 resolvido: $IPV4"
          else
            echo "Não foi possível resolver IPv4 via Python; seguiremos com a URL original."
          fi

      # Aplica migrações priorizando IPv4 + DoH; cai para URL original se necessário
      - name: Apply migrations to Supabase
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          SUPABASE_DB_URL_V4: ${{ env.SUPABASE_DB_URL_V4 }}
        run: |
          URL="${SUPABASE_DB_URL_V4:-$SUPABASE_DB_URL}"
          supabase db push --dns-resolver https --db-url "$URL" --include-all
