name: Supabase DB Push

on:
  push:
    paths:
      - "supabase/migrations/**"
      - ".github/workflows/supabase-db-push.yml"
  workflow_dispatch:

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1

      - name: Supabase CLI version
        run: supabase --version

      # Resolve o host do Supabase para IPv4 usando Python em ONE-LINERS (sem heredoc)
      - name: Build IPv4 DSN (best-effort, não falha)
        shell: bash
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          set +e
          DBURL="$SUPABASE_DB_URL"
          # extrai o host da URI
          HOST=$(DBURL="$DBURL" python3 -c "import os,urllib.parse; db=os.environ['DBURL']; u=urllib.parse.urlsplit(db.replace('postgresql://','http://',1)); print(u.hostname or '')")
          # resolve somente A record (IPv4)
          IPV4=$(HOST="$HOST" python3 -c "import os,socket; h=os.environ['HOST']; 
          print(socket.gethostbyname(h)) if h else print('')")
          if [ -n "$IPV4" ]; then
            DBURL_V4="${DBURL/$HOST/$IPV4}"
            echo "SUPABASE_DB_URL_V4=$DBURL_V4" >> "$GITHUB_ENV"
            echo "IPv4 resolvido: $IPV4"
          else
            echo "Sem IPv4 resolvido; seguiremos com a URL original."
          fi
          set -e

      # Aplica migrações priorizando IPv4 + DoH; se não tiver, usa a URL original
      - name: Apply migrations to Supabase
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          SUPABASE_DB_URL_V4: ${{ env.SUPABASE_DB_URL_V4 }}
        run: |
          URL="${SUPABASE_DB_URL_V4:-$SUPABASE_DB_URL}"
          supabase db push --dns-resolver https --db-url "$URL" --include-all
