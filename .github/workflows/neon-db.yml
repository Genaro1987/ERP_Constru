name: Neon â€” Apply Migrations

on:
  push:
    paths: ['db/migrations/**.sql', '.github/workflows/neon-db.yml']
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install psql client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Sanity check
        env: { DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }} }
        run: |
          [ -z "$DATABASE_URL" ] && { echo "NEON_DATABASE_URL ausente"; exit 1; }
          psql "$DATABASE_URL" -Atc "select 'ok', current_database();"

      - name: Apply migrations (ordered)
        env: { DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }} }
        run: |
          set -e
          for f in $(ls -1 db/migrations/*.sql | sort); do
            echo ">> Applying $f"
            psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f "$f"
          done
